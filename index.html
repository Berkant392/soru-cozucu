<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soru √á√∂z√ºc√º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .rainbow-active {
            position: relative;
            z-index: 1;
            background: #1a202c;
            color: white;
            border: 2px solid transparent;
        }
        .rainbow-active::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px;
            right: -2px; bottom: -2px;
            background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
            background-size: 400%;
            border-radius: 0.5rem;
            z-index: -1;
            animation: rainbow-move 3s linear infinite;
        }
        @keyframes rainbow-move {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        .inline-math {
            display: inline-block;
            background-color: #eef2ff;
            padding: 1px 6px;
            border-radius: 6px;
            margin: 0 3px;
            border: 1px solid #e0e7ff;
            vertical-align: middle;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .halkali-title {
            animation: text-color-change 6s linear infinite;
        }
        @keyframes text-color-change {
            0%   {color: #4f46e5;}
            25%  {color: #d946ef;}
            50%  {color: #14b8a6;}
            75%  {color: #f97316;}
            100% {color: #4f46e5;}
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const { createRoot } = ReactDOM;

        // --- G√úVENLƒ∞ KULLANICI VERƒ∞TABANI ---
        const credentials = new Map([
            ['7gT3jP', 'kLp9aV'], ['aBv4kS', '8rZ2mN'], ['cD9xWq', '5jH7fE'], ['eF6zYp', '2bC3dR'], ['gH1vUo', '9sX8wT'],
            ['iJ5tRn', '4mK1qL'], ['lM2sQp', '7nB6vC'], ['nP8rVo', '3dF4zG'], ['qR4tYn', '1hJ5kM'], ['sT9wXu', '6pL2sB'],
            ['uV7zYo', '8cE3vD'], ['wX3vUp', '5gH1rF'], ['yZ1tRn', '2jK6qL'], ['A2bC3d', '9mN4sV'], ['B5dE6f', '4pG8wT'],
            ['C8fG9h', '1rJ2uY'], ['D1hI2j', '7tL5xP'], ['E4jK5l', '3vN8zQ'], ['F7lM8n', '6sB1cF'], ['G9nO1p', '8wD4gH'],
            ['H3pQ4r', '5uF7jK'], ['I6rS7t', '2xL9mN'], ['J9tU1v', '9vC2sB'], ['K2vW3x', '4gH5wT'], ['L5xY6z', '1jK8rF'],
            ['M8z1A2', '7mN3qL'], ['N1B4C5', '3pG6vC'], ['O4D7E8', '6sB9zQ'], ['P7F9G1', '8wD2cF'], ['Q9H2I3', '5uF4gH'],
            ['R3J5K6', '2xL7jK'], ['S6L8M9', '9vC1mN'], ['T9N1O2', '4gH3sB'], ['U2P4Q5', '1jK6wT'], ['V5R7S8', '7mN8rF'],
            ['W8T9U1', '3pG2qL'], ['X1V3W4', '6sB5vC'], ['Y4Z6A7', '8wD8zQ'], ['Z7B9C1', '5uF1cF'], ['a3d6f8', '2xL3gH'],
            ['b6g9h1', '9vC5jK'], ['c9j2k4', '4gH7mN'], ['d2l5m7', '1jK9sB'], ['e5n8p1', '7mN2wT'], ['f8q1r3', '3pG4rF'],
            ['g1s4t6', '6sB7qL'], ['h4u7v9', '8wD9vC'], ['i7x1y2', '5uF2zQ'], ['j9z3a5', '2xL4cF'], ['k3b6c8', '9vC6gH'],
            ['l6d9e1', '4gH8jK'], ['m9f2g4', '1jK1mN'], ['n2h5i7', '7mN3sB'], ['o5j8k1', '3pG5wT'], ['p8l1m3', '6sB7rF'],
            ['q1n4o6', '8wD9qL'], ['r4p7q9', '5uF2vC'], ['s7r1s2', '2xL4zQ'], ['t9t4u5', '9vC6cF'], ['u3v7w8', '4gH8gH'],
            ['v6x9y1', '1jK1jK'], ['w9z2a3', '7mN3mN'], ['x2b5c6', '3pG5sB'], ['y5d8e9', '6sB7wT'], ['z8f1g2', '8wD9rF'],
            ['A1B2C3', '5uF2qL'], ['D4E5F6', '2xL4vC'], ['G7H8I9', '9vC6zQ'], ['J1K2L3', '4gH8cF'], ['M4N5O6', '1jK1gH'],
            ['P7Q8R9', '7mN3jK'], ['S1T2U3', '3pG5mN'], ['V4W5X6', '6sB7sB'], ['Y7Z8A9', '8wD9wT'], ['B1C2D3', '5uF2rF'],
            ['E4F5G6', '2xL4qL'], ['H7I8J9', '9vC6vC'], ['K1L2M3', '4gH8zQ'], ['N4O5P6', '1jK1cF'], ['Q7R8S9', '7mN3gH'],
            ['T1U2V3', '3pG5jK'], ['W4X5Y6', '6sB7mN'], ['Z7A8B9', '8wD9sB'], ['c1d2e3', '5uF2wT'], ['f4g5h6', '2xL4rF'],
            ['i7j8k9', '9vC6qL'], ['l1m2n3', '4gH8vC'], ['o4p5q6', '1jK1zQ'], ['r7s8t9', '7mN3cF'], ['u1v2w3', '3pG5gH'],
            ['x4y5z6', '6sB7jK'], ['a7b8c9', '8wD9mN'], ['d1e2f3', '5uF2sB'], ['g4h5i6', '2xL4wT'], ['j7k8l9', '9vC6rF'],
            ['m1n2o3', '4gH8qL'], ['p4q5r6', '1jK1vC'], ['s7t8u9', '7mN3zQ'], ['v1w2x3', '3pG5cF'], ['y4z5a6', '6sB7gH'],
            ['b7c8d9', '8wD9jK'], ['e1f2g3', '5uF2mN'], ['h4i5j6', '2xL4sB'], ['k7l8m9', '9vC6wT'], ['n1o2p3', '4gH8rF'],
            ['q4r5s6', '1jK1qL'], ['t7u8v9', '7mN3vC'], ['w1x2y3', '3pG5zQ'], ['z4a5b6', '6sB7cF'], ['c7d8e9', '8wD9gH'],
            ['f1g2h3', '5uF2jK'], ['i4j5k6', '2xL4mN'], ['l7m8n9', '9vC6sB'], ['o1p2q3', '4gH8wT'], ['r4s5t6', '1jK1rF'],
            ['u7v8w9', '7mN3qL'], ['x1y2z3', '3pG5vC'], ['a4b5c6', '6sB7zQ'], ['d7e8f9', '8wD9cF'], ['g1h2i3', '5uF2gH'],
            ['j4k5l6', '2xL4jK'], ['m7n8o9', '9vC6mN'], ['p1q2r3', '4gH8sB'], ['s4t5u6', '1jK1wT'], ['v7w8x9', '7mN3rF'],
            ['y1z2a3', '3pG5qL'], ['b4c5d6', '6sB7vC'], ['e7f8g9', '8wD9zQ'], ['h1i2j3', '5uF2cF'], ['k4l5m6', '2xL4gH'],
            ['n7o8p9', '9vC6jK'], ['q1r2s3', '4gH8mN'], ['t4u5v6', '1jK1sB'], ['w7x8y9', '7mN3wT'], ['z1a2b3', '3pG5rF'],
            ['c4d5e6', '6sB7qL'], ['f7g8h9', '8wD9vC'], ['i1j2k3', '5uF2zQ'], ['l4m5n6', '2xL4cF'], ['o7p8q9', '9vC6gH'],
            ['r1s2t3', '4gH8jK'], ['u4v5w6', '1jK1mN'], ['x7y8z9', '7mN3sB'], ['a1b3c5', '3pG5wT'], ['d4e6f8', '6sB7rF'],
            ['g7h9i1', '8wD9qL'], ['j2k4l6', '5uF2vC'], ['m5n7o9', '2xL4zQ'], ['p8q1r2', '9vC6cF'], ['s3t5u7', '4gH8gH'],
            ['v9w1x3', '1jK1jK'], ['y5z7a9', '7mN3mN'], ['b2c4d6', '3pG5sB'], ['e8f1g3', '6sB7wT'], ['h5i7j9', '8wD9rF'],
            ['k2l4m6', '5uF2qL'], ['n8o1p3', '2xL4vC'], ['q5r7s9', '9vC6zQ'], ['t2u4v6', '4gH8cF'], ['w8x1y3', '1jK1gH'],
            ['z5a7b9', '7mN3jK'], ['c2d4e6', '3pG5mN'], ['f8g1h3', '6sB7sB'], ['i5j7k9', '8wD9wT'], ['l2m4n6', '5uF2rF'],
            ['o8p1q3', '2xL4qL'], ['r5s7t9', '9vC6vC'], ['u2v4w6', '4gH8zQ'], ['x8y1z3', '1jK1cF'], ['a5b7c9', '7mN3gH'],
            ['d2e4f6', '3pG5jK'], ['g8h1i3', '6sB7mN'], ['j5k7l9', '8wD9sB'], ['m2n4o6', '5uF2wT'], ['p8q1r3', '2xL4rF'],
            ['s5t7u9', '9vC6qL'], ['v2w4x6', '4gH8vC'], ['y8z1a3', '1jK1zQ'], ['b5c7d9', '7mN3cF'], ['e2f4g6', '3pG5gH'],
            ['h8i1j3', '6sB7jK'], ['k5l7m9', '8wD9mN'], ['n2o4p6', '5uF2sB'], ['q8r1s3', '2xL4wT'], ['t5u7v9', '9vC6rF'],
            ['w2x4y6', '4gH8qL'], ['z8a1b3', '1jK1vC'], ['c5d7e9', '7mN3zQ'], ['f2g4h6', '3pG5cF'], ['i8j1k3', '6sB7gH'],
            ['l5m7n9', '8wD9jK'], ['o2p4q6', '5uF2mN'], ['r8s1t3', '2xL4sB'], ['u5v7w9', '9vC6wT'], ['x2y4z6', '4gH8rF'],
            ['a8b1c3', '1jK1qL'], ['d5e7f9', '7mN3vC'], ['g2h4i6', '3pG5zQ'], ['j8k1l3', '6sB7cF'], ['m5n7o9', '8wD9gH'],
            ['p2q4r6', '5uF2jK'], ['s8t1u3', '2xL4mN'], ['v5w7x9', '9vC6sB'], ['y2z4a6', '4gH8wT'], ['b8c1d3', '1jK1rF'],
            ['e5f7g9', '7mN3qL'], ['h2i4j6', '3pG5vC'], ['k8l1m3', '6sB7zQ'], ['n5o7p9', '8wD9cF'], ['q2r4s6', '5uF2gH'],
            ['t8u1v3', '2xL4jK'], ['w5x7y9', '9vC6mN'], ['z2a4b6', '4gH8sB'], ['c8d1e3', '1jK1wT'], ['f5g7h9', '7mN3rF'],
            ['i2j4k6', '3pG5qL'], ['l8m1n3', '6sB7vC'], ['o5p7q9', '8wD9zQ'], ['r2s4t6', '5uF2cF'], ['u8v1w3', '2xL4gH'],
            ['x5y7z9', '9vC6jK'], ['Zq4w7e', '8r2t5y'], ['Xp1o9i', 'u6i3o1'], ['Cb5n8m', 'k2j4h6'], ['Vg9f2d', 's5a7z1'],
            ['Bn4m7k', 'j8h6g5'], ['Lk1j8h', 'g2f4d6'], ['Pq5r8t', 'y1u3i5'], ['Oa2s5d', 'f7g9h2'], ['Iu6y9t', 'r4e1w3'],
            ['Uj3m7k', 'l9o1p4'], ['Yt5r2e', 'w6q8a1'], ['Ts1a4z', 'e5d7c9'], ['Rg9f6c', 'v3b5n8'], ['Fv2b5n', 'm1k3j6'],
            ['Dc4r7f', 't8g2y5'], ['Sw6a9q', 'z1x3c5'], ['Az8s5x', 'd2f4g7']
        ]);
        // --- Bƒ∞Tƒ∞≈û ---
        
        const quoteColors = [
            'bg-blue-50 text-blue-800 border-blue-200',
            'bg-green-50 text-green-800 border-green-200',
            'bg-yellow-50 text-yellow-800 border-yellow-200',
            'bg-pink-50 text-pink-800 border-pink-200',
            'bg-gray-100 text-gray-800 border-gray-200',
            'bg-red-50 text-red-800 border-red-200',
        ];

        const UniversalMathRenderer = ({ text, isSolution = false }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && text && typeof katex !== 'undefined') {
                    const contentContainer = document.createElement('div');
                    const processText = (textToProcess) => {
                        const fragment = document.createDocumentFragment();
                        const parts = textToProcess.split(/(\$\$[^$$]+\$\$|\$[^$]+\$)/g).filter(Boolean);
                        parts.forEach(part => {
                            let katexHandled = false;
                            if (part.startsWith('$$') && part.endsWith('$$')) {
                                const span = document.createElement('span');
                                span.className = 'inline-math';
                                try { katex.render(part.slice(2, -2), span, { throwOnError: false, displayMode: false }); katexHandled = true; } catch (e) {}
                                fragment.appendChild(span);
                            } else if (part.startsWith('$') && part.endsWith('$')) {
                                const span = document.createElement('span');
                                try { katex.render(part.slice(1, -1), span, { throwOnError: false, displayMode: false }); katexHandled = true; } catch (e) {}
                                fragment.appendChild(span);
                            }
                            if (!katexHandled) fragment.appendChild(document.createTextNode(part));
                        });
                        return fragment;
                    };
                    if (isSolution) {
                        const solutionWrapper = document.createElement('div');
                        solutionWrapper.className = 'bg-white p-4 sm:p-6 rounded-lg shadow-inner text-gray-700 leading-relaxed';
                        const lines = text.split('\n').filter(line => line.trim() !== '');
                        lines.forEach(line => {
                            const p = document.createElement('p');
                            p.className = 'mb-3';
                            p.appendChild(processText(line));
                            solutionWrapper.appendChild(p);
                        });
                        contentContainer.appendChild(solutionWrapper);
                    } else {
                        contentContainer.className = "whitespace-pre-wrap font-sans text-gray-700";
                        contentContainer.appendChild(processText(text));
                    }
                    containerRef.current.innerHTML = '';
                    containerRef.current.appendChild(contentContainer);
                }
            }, [text, isSolution]);
            return <div ref={containerRef} className="text-gray-800 leading-relaxed"></div>;
        };
        
        const ChartRenderer = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (chartRef.current && data) {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: data.type,
                        data: data.data,
                        options: data.options || {}
                    });
                }
            }, [data]);

            return <canvas ref={chartRef}></canvas>;
        };

        const SoruCozucuPage = () => {
            const [image, setImage] = useState(null);
            const [imageBase64, setImageBase64] = useState('');
            const [selectedSubject, setSelectedSubject] = useState(null);
            const [analysis, setAnalysis] = useState('');
            const [solution, setSolution] = useState('');
            const [chartData, setChartData] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [error, setError] = useState('');
            const [stage, setStage] = useState('upload'); 
            const [showFeedback, setShowFeedback] = useState(false);
            const [showReSolvePrompt, setShowReSolvePrompt] = useState(false);
            const [motivationalQuote, setMotivationalQuote] = useState({ text: 'Y√ºkleniyor...', author: '', colorClass: 'bg-gray-100' });
            const fileInputRef = useRef(null);

            const subjects = ['Matematik', 'Fizik', 'Kimya', 'Biyoloji', 'Tarih', 'Coƒürafya', 'Edebiyat', 'T√ºrk√ße'];

            const fetchMotivationalQuote = async () => {
                const prompt = "Lise √∂ƒürencileri i√ßin ba≈üarƒ±, √ßalƒ±≈üma, kazanma, matematiƒüin veya bilimin √∂nemi gibi konularda motive edici, √ße≈üitli ve daha √∂nce pek duyulmamƒ±≈ü, tek bir √∂zl√º s√∂z olu≈ütur. Bu s√∂z bir atas√∂z√º, anonim bir s√∂z veya √ºnl√º bir ki≈üiye ait olabilir. Cevabƒ±nƒ± JSON formatƒ±nda `{ \"quote\": \"s√∂z metni\", \"author\": \"s√∂yleyen ki≈üi\" }` olarak ver.";
                
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { 
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "quote": { "type": "STRING" },
                                "author": { "type": "STRING" }
                            },
                            required: ["quote", "author"]
                        }
                    }
                };

                const apiUrl = `/.netlify/functions/yapay-zeka`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        const json = JSON.parse(result.candidates[0].content.parts[0].text);
                        const colorIndex = Math.floor(Math.random() * quoteColors.length);
                        setMotivationalQuote({ text: json.quote, author: json.author, colorClass: quoteColors[colorIndex] });
                    }
                } catch (e) {
                    console.error("Motivasyon s√∂z√º alƒ±namadƒ±:", e);
                    setMotivationalQuote({ text: "En b√ºy√ºk zafer, kendimize kar≈üƒ± kazandƒ±ƒüƒ±mƒ±zdƒ±r.", author: "Platon", colorClass: 'bg-blue-50 text-blue-800 border-blue-200' });
                }
            };
            
            useEffect(() => {
                fetchMotivationalQuote();
            }, []);

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    setImage(URL.createObjectURL(file));
                    setError(''); setAnalysis(''); setSolution(''); setSelectedSubject(null);
                    setShowFeedback(false); setShowReSolvePrompt(false); setChartData(null);
                    setStage('image_uploaded');
                    const reader = new FileReader();
                    reader.onloadend = () => setImageBase64(reader.result.split(',')[1]);
                    reader.onerror = () => setError('Dosya okunurken bir hata olu≈ütu.');
                    reader.readAsDataURL(file);
                }
            };

            const triggerFileSelect = () => fileInputRef.current.click();

            const callGeminiAPI = async (prompt) => {
                if (!imageBase64) { setError('L√ºtfen √∂nce bir resim dosyasƒ± se√ßin.'); return null; }
                setIsLoading(true);
                setError('');
                const payload = { contents: [{ role: "user", parts: [ { text: prompt }, { inlineData: { mimeType: "image/jpeg", data: imageBase64 } } ] }] };
                
                const apiUrl = `/.netlify/functions/yapay-zeka`;

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                         const errorText = await response.text();
                         throw new Error(`API Sunucu Hatasƒ±: ${response.status} - ${errorText}`);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates[0]?.content?.parts?.[0]) return result.candidates[0].content.parts[0].text;
                    const errorMessage = result.promptFeedback?.blockReason || JSON.stringify(result);
                    throw new Error(`API'den ge√ßerli bir yanƒ±t alƒ±namadƒ±: ${errorMessage}`);
                } catch (err) {
                    setError(err.message || 'Bilinmeyen bir hata olu≈ütu.');
                    return null;
                } finally {
                    setIsLoading(false);
                    setLoadingMessage('');
                }
            };

            const handleAnalysis = async (isReAnalysis = false) => {
                if(!selectedSubject) { setError('L√ºtfen √∂nce bir ders se√ßin.'); return; }
                setStage('analyzing');
                setLoadingMessage(isReAnalysis ? 'Hata anla≈üƒ±lƒ±yor, yeniden analiz ediliyor...' : 'Analiz ediliyor...');
                const prompt = `Sen bir ${selectedSubject} uzmanƒ±sƒ±n. Bu resimdeki ${selectedSubject} sorusunu analiz et.
**Kesin Kurallar:**
1.  Sadece soruda verilenleri ve ne istendiƒüini, bir lise √∂ƒürencisinin anlayacaƒüƒ± net ve kƒ±sa ifadelerle listele.
2.  √á√∂z√ºme dair **hi√ßbir ipucu verme** veya √ß√∂z√ºm√º **yapma**. Sadece analiz yap.
3.  Cevabƒ±nƒ± '### Analiz:' ba≈ülƒ±ƒüƒ± altƒ±nda, 'Verilenler:' ve 'ƒ∞stenenler:' etiketleriyle olu≈ütur.
4.  Analizin sonuna **mutlaka** ≈üu c√ºmleyi ekle: "Analiz tamamlandƒ±. √á√∂z√ºm√º g√∂rmek i√ßin 4. Adƒ±m: √á√∂z√ºm butonuna tƒ±klayabilirsin."`;
                const analysisResult = await callGeminiAPI(prompt);
                if (analysisResult) { 
                    setAnalysis(analysisResult.replace(/### Analiz:/g, '')); 
                    setStage('analysis_done'); 
                    return true;
                } else { 
                    setStage('subject_selected'); 
                    return false;
                }
            };

            const handleSolution = async (isReSolve = false) => {
                if(!selectedSubject) { setError('L√ºtfen √∂nce bir ders se√ßin.'); return; }
                setStage('solving');
                setLoadingMessage(isReSolve ? 'Analiz tamamlandƒ±, yeniden √ß√∂z√ºl√ºyor...' : '√á√∂z√ºm olu≈üturuluyor...');
                
                let prompt = `Sen, lise √∂ƒürencilerine ders anlatan ve en karma≈üƒ±k konularƒ± bile en basit ve pratik yolla a√ßƒ±klayan bir ${selectedSubject} uzmanƒ±sƒ±n. Bu resimdeki soruyu √ß√∂z/a√ßƒ±kla.
**KURALLAR:**
1.  **√á√∂z√ºm√ºn Anla≈üƒ±lƒ±rlƒ±ƒüƒ±:** √á√∂z√ºm√º adƒ±m adƒ±m, kƒ±sa ve pratik bir ≈üekilde a√ßƒ±kla.
2.  **G√∂rselle≈ütirme Kararƒ± (Sadece Matematik i√ßin):** Eƒüer ders Matematik ise, √ß√∂z√ºm√º daha anla≈üƒ±lƒ±r kƒ±lmak i√ßin bir grafik veya geometrik ≈üekil √ßizmenin **gerekli olup olmadƒ±ƒüƒ±na karar ver.** G√∂rselle≈ütirme, sadece sorunun anla≈üƒ±lmasƒ±na **ciddi anlamda** yardƒ±mcƒ± olacaksa kullanƒ±lmalƒ±dƒ±r.
3.  **√áƒ±ktƒ± Formatƒ±:** Cevabƒ±nƒ± iki b√∂l√ºmde ver:
    * '### √á√∂z√ºm:' ba≈ülƒ±ƒüƒ± altƒ±nda adƒ±m adƒ±m metin √ß√∂z√ºm√ºn√º yaz. T√ºm matematiksel form√ºlleri '$$...$$' arasƒ±na al.
    * Eƒüer bir g√∂rsel olu≈üturmaya karar verdiysen, metin √ß√∂z√ºm√ºn√ºn sonuna '### √áizim:' ba≈ülƒ±ƒüƒ± ekle ve hemen altƒ±na, √ßizim i√ßin gerekli verileri i√ßeren bir JSON nesnesi yaz. JSON formatƒ± ≈ü√∂yle olmalƒ±: { "type": "line", "data": { "labels": [...], "datasets": [...] }, "options": {...} } veya { "type": "scatter", "data": { "datasets": [...] }, "options": {...} }. JSON'u kod bloƒüu i√ßine alma.
Eƒüer g√∂rsel gerekmiyorsa, '### √áizim:' b√∂l√ºm√ºn√º ve JSON nesnesini ekleme.`;

                if(isReSolve) {
                    prompt = `Daha √∂nceki √ß√∂z√ºm√ºm hatalƒ± veya eksik olarak i≈üaretlendi. Az √∂nce yaptƒ±ƒüƒ±m detaylƒ± analizi dikkate alarak, bu resimdeki ${selectedSubject} sorusunu **√∂nceki hatamƒ± tekrarlamayacak ≈üekilde, √ßok daha dikkatli, anla≈üƒ±lƒ±r ve basite indirgeyerek** yeniden √ß√∂z. Adƒ±mlarƒ± net bir ≈üekilde a√ßƒ±kla ve doƒüru sonuca ula≈ü.` + prompt;
                }
                
                const resultText = await callGeminiAPI(prompt);
                
                if (resultText) {
                    const parts = resultText.split('### √áizim:');
                    setSolution(parts[0].replace('### √á√∂z√ºm:', '').trim());
                    if (parts.length > 1 && parts[1].trim()) {
                        try {
                            const jsonString = parts[1].replace(/```json\n|```/g, '');
                            const parsedChartData = JSON.parse(jsonString);
                            setChartData(parsedChartData);
                        } catch (e) {
                            console.error("√áizim verisi ayrƒ±≈ütƒ±rƒ±lamadƒ±:", e);
                            setChartData(null);
                        }
                    } else {
                        setChartData(null);
                    }
                    setStage('solution_done'); 
                    setShowFeedback(true);
                } else { 
                    setStage('analysis_done'); 
                }
            };
            
            const handleReSolve = async () => {
                setShowReSolvePrompt(false);
                setSolution('');
                setChartData(null);
                const analysisSuccess = await handleAnalysis(true);
                if(analysisSuccess){
                    await handleSolution(true);
                }
            };
            
            const resetApp = () => {
                setImage(null); setImageBase64(''); setAnalysis(''); setSolution('');
                setError(''); setStage('upload'); setSelectedSubject(null);
                setShowFeedback(false); setShowReSolvePrompt(false); setChartData(null);
                fetchMotivationalQuote();
                if(fileInputRef.current) fileInputRef.current.value = "";
            };

            return (
                <div className="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-4 sm:p-6 md:p-8">
                    <header className="text-center mb-6">
                        <p className="halkali-title text-lg font-semibold mb-2">Halkalƒ± Fen Bilimleri Merkezi</p>
                        <h1 className="text-3xl sm:text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-500 to-red-500">Soru √á√∂z√ºc√º</h1>
                        <p className="text-base font-semibold bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent mt-2">Berkant Hoca</p>
                        {motivationalQuote && (
                            <div className={`mt-4 p-3 rounded-lg text-sm transition-colors duration-500 border ${motivationalQuote.colorClass}`}>
                                <p className="italic">"{motivationalQuote.text}"</p>
                                <p className="font-semibold mt-1 text-right">- {motivationalQuote.author}</p>
                            </div>
                        )}
                        <p className="text-gray-600 mt-4 text-sm sm:text-base">Sorunun fotoƒürafƒ±nƒ± y√ºkle, dersini se√ß ve √ß√∂z√ºm√º g√∂r!</p>
                    </header>
                    {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">{error}</div>}
                    <div className="flex flex-col gap-6">
                        <div className="flex flex-col md:flex-row gap-4 md:gap-6 items-start">
                            <div className="w-full md:w-1/2 flex flex-col items-center justify-center bg-gray-50 p-4 sm:p-6 rounded-lg border-2 border-dashed h-full">
                                <input type="file" accept="image/*" onChange={handleFileChange} ref={fileInputRef} className="hidden" />
                                {image ? (<img src={image} alt="Y√ºklenen Soru" className="max-w-full max-h-48 sm:max-h-60 mx-auto rounded-lg shadow-md" />) : (<div className="text-center py-8 cursor-pointer w-full" onClick={triggerFileSelect}><svg className="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg><p className="mt-2 text-sm font-medium text-gray-700">1. Adƒ±m: Fotoƒüraf Y√ºkle</p></div>)}
                            </div>
                            <div className="w-full md:w-1/2 flex flex-col justify-center space-y-3">
                                 {image && <button onClick={resetApp} className="w-full bg-red-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-600 transition duration-300">Yeni Soru Y√ºkle</button>}
                                <button onClick={() => handleAnalysis(false)} disabled={isLoading || !selectedSubject} className="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">3. Adƒ±m: Analiz</button>
                                <button onClick={() => handleSolution(false)} disabled={isLoading || stage !== 'analysis_done'} className="w-full bg-purple-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-600 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">4. Adƒ±m: √á√∂z√ºm</button>
                                {isLoading && <div className="mt-4 flex flex-col items-center justify-center"><div className="loader"></div><p className="text-gray-600 mt-2">{loadingMessage}</p></div>}
                            </div>
                        </div>
                        {image && (<div className="w-full pt-4 border-t"><h2 className="text-lg font-semibold text-center text-gray-700 mb-3">2. Adƒ±m: Dersi Se√ß</h2><div className="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3">{subjects.map(subject => (<button key={subject} onClick={() => setSelectedSubject(subject)} className={`py-2 px-3 rounded-lg font-semibold transition-all duration-200 text-sm sm:text-base ${selectedSubject === subject ? 'rainbow-active' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>{subject}</button>))}</div></div>)}
                        {(analysis || solution) && (<div className="space-y-8 mt-6 pt-6 border-t">{analysis && (<div className="bg-blue-50 p-4 sm:p-5 rounded-lg shadow-sm border border-blue-200"><h2 className="text-lg sm:text-xl font-bold text-blue-800 mb-3">Analiz</h2><UniversalMathRenderer text={analysis} /></div>)}{solution && (<div><h2 className="text-xl sm:text-2xl font-bold text-indigo-800 mb-4 text-center">√á√∂z√ºm</h2><UniversalMathRenderer text={solution} isSolution={true} /></div>)}{chartData && (<div><h2 className="text-xl sm:text-2xl font-bold text-indigo-800 mb-4 text-center">G√∂rselle≈ütirme</h2><div className="bg-white p-4 rounded-lg shadow-md"><ChartRenderer data={chartData} /></div></div>)}</div>)}
                        
                        {showFeedback && (
                            <div className="mt-6 p-4 bg-purple-100 border border-purple-200 rounded-lg text-center">
                                <h3 className="font-semibold text-purple-800 mb-3">√á√∂z√ºm√º Deƒüerlendir</h3>
                                <div className="flex justify-center gap-4">
                                    <button onClick={() => { alert('Geri bildiriminiz i√ßin te≈üekk√ºrler!'); setShowFeedback(false); }} className="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                                        <span>üëç</span> Beƒüendim
                                    </button>
                                    <button onClick={() => { setShowFeedback(false); setShowReSolvePrompt(true); }} className="flex items-center gap-2 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
                                        <span>üëé</span> Hatalƒ±/Eksik
                                    </button>
                                </div>
                            </div>
                        )}

                        {showReSolvePrompt && (
                             <div className="mt-6 p-4 bg-yellow-100 border border-yellow-200 rounded-lg text-center">
                                <p className="font-semibold text-yellow-800 mb-3">Geri bildiriminiz i√ßin te≈üekk√ºrler, artƒ±k daha dikkatli olacaƒüƒ±m. Soruyu daha dikkatli bir ≈üekilde yeniden √ß√∂zmemi ister misiniz?</p>
                                <div className="flex justify-center gap-4">
                                    <button onClick={handleReSolve} className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">Evet, yeniden √ß√∂z</button>
                                    <button onClick={() => setShowReSolvePrompt(false)} className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">Hayƒ±r, te≈üekk√ºrler</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        const LoginPage = ({ onLoginSuccess }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [loginError, setLoginError] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                if (credentials.has(username) && credentials.get(username) === password) {
                    onLoginSuccess();
                } else {
                    setLoginError('Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±. Halkalƒ± Fen Bilimleri Merkezi √∂ƒürencisi iseniz Berkant Hocadan kullanƒ±cƒ± adƒ± ve ≈üifre alabilirsiniz.');
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 px-4">
                    <div className="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg text-center">
                        <h1 className="text-xl sm:text-2xl font-bold text-gray-800 mb-4">
                            <span className="halkali-title block mb-1">Halkalƒ± Fen Bilimleri Merkezi</span>
                            <span>Soru √á√∂z√ºc√º Uygulamasƒ±na Ho≈ü Geldiniz</span>
                        </h1>
                        <p className="text-gray-600 mb-6">L√ºtfen giri≈ü yapƒ±nƒ±z.</p>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input 
                                type="text"
                                placeholder="Kullanƒ±cƒ± Adƒ±"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                                className="w-full px-4 py-3 bg-purple-50 border border-purple-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            />
                            <input 
                                type="password"
                                placeholder="≈ûifre"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full px-4 py-3 bg-purple-50 border border-purple-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            />
                            <button type="submit" className="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">
                                Giri≈ü Yap
                            </button>
                        </form>
                        {loginError && <p className="mt-4 text-sm text-red-600 bg-red-100 p-3 rounded-lg">{loginError}</p>}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);

            if (!isLoggedIn) {
                return <LoginPage onLoginSuccess={() => setIsLoggedIn(true)} />;
            }

            return (
                 <div className="min-h-screen bg-gray-50 flex items-center justify-center p-2 sm:p-4">
                    <SoruCozucuPage />
                 </div>
            );
        };

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
