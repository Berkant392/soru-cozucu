<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soru Çözücü</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .rainbow-active {
            position: relative;
            z-index: 1;
            background: #1a202c;
            color: white;
            border: 2px solid transparent;
        }
        .rainbow-active::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px;
            right: -2px; bottom: -2px;
            background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
            background-size: 400%;
            border-radius: 0.5rem; /* 8px */
            z-index: -1;
            animation: rainbow-move 3s linear infinite;
        }
        @keyframes rainbow-move {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        .inline-math {
            display: inline-block;
            background-color: #eef2ff;
            padding: 1px 6px;
            border-radius: 6px;
            margin: 0 3px;
            border: 1px solid #e0e7ff;
            vertical-align: middle;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .halkali-title {
            animation: text-color-change 6s linear infinite;
        }
        @keyframes text-color-change {
            0%   {color: #4f46e5;} /* indigo */
            25%  {color: #d946ef;} /* fuchsia */
            50%  {color: #14b8a6;} /* teal */
            75%  {color: #f97316;} /* orange */
            100% {color: #4f46e5;} /* indigo */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const { createRoot } = ReactDOM;

        const UniversalMathRenderer = ({ text, isSolution = false }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && text && typeof katex !== 'undefined') {
                    const contentContainer = document.createElement('div');
                    
                    const processText = (textToProcess) => {
                        const fragment = document.createDocumentFragment();
                        const parts = textToProcess.split(/(\$\$[^$$]+\$\$|\$[^$]+\$)/g).filter(Boolean);
                        
                        parts.forEach(part => {
                            let katexHandled = false;
                            if (part.startsWith('$$') && part.endsWith('$$')) {
                                const span = document.createElement('span');
                                span.className = 'inline-math';
                                try {
                                    katex.render(part.slice(2, -2), span, { throwOnError: false, displayMode: false });
                                    katexHandled = true;
                                } catch (e) { /* fallback */ }
                                fragment.appendChild(span);
                            } else if (part.startsWith('$') && part.endsWith('$')) {
                                const span = document.createElement('span');
                                try {
                                    katex.render(part.slice(1, -1), span, { throwOnError: false, displayMode: false });
                                    katexHandled = true;
                                } catch (e) { /* fallback */ }
                                fragment.appendChild(span);
                            }
                            
                            if (!katexHandled) {
                                fragment.appendChild(document.createTextNode(part));
                            }
                        });
                        return fragment;
                    };

                    if (isSolution) {
                        const solutionWrapper = document.createElement('div');
                        solutionWrapper.className = 'bg-white p-4 sm:p-6 rounded-lg shadow-inner text-gray-700 leading-relaxed';
                        
                        const lines = text.split('\n').filter(line => line.trim() !== '');
                        lines.forEach(line => {
                            const p = document.createElement('p');
                            p.className = 'mb-3';
                            p.appendChild(processText(line));
                            solutionWrapper.appendChild(p);
                        });
                        contentContainer.appendChild(solutionWrapper);

                    } else {
                        contentContainer.className = "whitespace-pre-wrap font-sans text-gray-700";
                        contentContainer.appendChild(processText(text));
                    }
                    
                    containerRef.current.innerHTML = '';
                    containerRef.current.appendChild(contentContainer);
                }
            }, [text, isSolution]);

            return <div ref={containerRef} className="text-gray-800 leading-relaxed"></div>;
        };


        const App = () => {
            const [image, setImage] = useState(null);
            const [imageBase64, setImageBase64] = useState('');
            const [selectedSubject, setSelectedSubject] = useState(null);
            const [analysis, setAnalysis] = useState('');
            const [solution, setSolution] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            const [stage, setStage] = useState('upload'); 
            const fileInputRef = useRef(null);

            const subjects = ['Matematik', 'Fizik', 'Kimya', 'Biyoloji', 'Tarih', 'Coğrafya', 'Edebiyat', 'Türkçe'];

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    setImage(URL.createObjectURL(file));
                    setError(''); setAnalysis(''); setSolution(''); setSelectedSubject(null);
                    setStage('image_uploaded');
                    const reader = new FileReader();
                    reader.onloadend = () => setImageBase64(reader.result.split(',')[1]);
                    reader.onerror = () => setError('Dosya okunurken bir hata oluştu.');
                    reader.readAsDataURL(file);
                }
            };

            const triggerFileSelect = () => fileInputRef.current.click();

            const callGeminiAPI = async (prompt) => {
                if (!imageBase64) {
                    setError('Lütfen önce bir resim dosyası seçin.');
                    return null;
                }
                setIsLoading(true);
                setError('');
                const payload = { contents: [{ role: "user", parts: [ { text: prompt }, { inlineData: { mimeType: "image/jpeg", data: imageBase64 } } ] }] };
                
                const apiUrl = `/.netlify/functions/yapay-zeka`;

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                         const errorText = await response.text();
                         throw new Error(`API Sunucu Hatası: ${response.status} - ${errorText}`);
                    }
                    const result = await response.json();
                    if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        const errorMessage = result.promptFeedback?.blockReason || JSON.stringify(result);
                        throw new Error(`API'den geçerli bir yanıt alınamadı: ${errorMessage}`);
                    }
                } catch (err) {
                    setError(err.message || 'Bilinmeyen bir hata oluştu.');
                    return null;
                } finally {
                    setIsLoading(false);
                }
            };

            const handleAnalysis = async () => {
                if(!selectedSubject) { setError('Lütfen önce bir ders seçin.'); return; }
                setStage('analyzing');
                const prompt = `Sen bir ${selectedSubject} uzmanısın. Bu resimdeki ${selectedSubject} sorusunda verilenleri ve istenenleri analiz et. Cevabını '### Analiz:' başlığı altında, 'Verilenler:' ve 'İstenenler:' etiketleriyle, madde madde listele. Matematiksel/bilimsel ifadeleri metin içinde göstermen gerekirse $a=2b$ gibi tek dolar işareti kullanabilirsin.`;
                const analysisResult = await callGeminiAPI(prompt);
                if (analysisResult) { setAnalysis(analysisResult.replace(/### Analiz:/g, '')); setStage('analysis_done'); } 
                else { setStage('subject_selected'); }
            };

            const handleSolution = async () => {
                if(!selectedSubject) { setError('Lütfen önce bir ders seçin.'); return; }
                setStage('solving');
                const prompt = `Sen, lise öğrencilerine ders anlatan ve en karmaşık konuları bile en basit ve pratik yolla açıklayan bir uzmansın.
Bu resimdeki ${selectedSubject} sorusunu çöz/açıkla.
**En Önemli Kural:** Çözümlerin **kesinlikle** çok kısa, pratik ve bir lise öğrencisinin anlayacağı seviyede olmalı. Uzun ve ayrıntılı açıklamalardan **kesinlikle kaçın**. Sadece sorunun cevabını bulmak için gerekli olan ana adımları göster.
- **Sayısal Dersler (Matematik, Fizik, Kimya):** Sadece kilit işlem adımlarını göster.
- **Sözel/Biyoloji Dersleri:** Cevabı uzun paragraflar yerine, birkaç net cümle veya madde ile özetle.
- **Biçim Kuralı:** Tüm matematiksel/bilimsel formülleri **sadece** LaTeX formatında ve çift dolar işareti arasına yazarak ('$$...$$') göster. Yanıtında **asla** tek dolar işareti ($) kullanma. Çözümü '### Çözüm:' başlığı altında sun.`;
                const resultText = await callGeminiAPI(prompt);
                if (resultText) { setSolution(resultText.replace('### Çözüm:', '').trim()); setStage('solution_done'); } 
                else { setStage('analysis_done'); }
            };
            
            const resetApp = () => {
                setImage(null); setImageBase64(''); setAnalysis(''); setSolution('');
                setError(''); setStage('upload'); setSelectedSubject(null);
                if(fileInputRef.current) fileInputRef.current.value = "";
            };

            return (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center p-2 sm:p-4">
                    <div className="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-4 sm:p-6 md:p-8">
                        <header className="text-center mb-6">
                            <p className="halkali-title text-lg font-semibold mb-2">Halkalı Fen Bilimleri Merkezi</p>
                            <h1 className="text-3xl sm:text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-500 to-red-500">
                                Soru Çözücü
                            </h1>
                            <p className="text-base font-semibold bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent mt-2">Berkant Hoca</p>
                            <p className="text-gray-600 mt-3 text-sm sm:text-base">Sorunun fotoğrafını yükle, dersini seç ve çözümü gör!</p>
                        </header>
                        {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">{error}</div>}
                        <div className="flex flex-col gap-6">
                            <div className="flex flex-col md:flex-row gap-4 md:gap-6 items-start">
                                <div className="w-full md:w-1/2 flex flex-col items-center justify-center bg-gray-50 p-4 sm:p-6 rounded-lg border-2 border-dashed h-full">
                                    <input type="file" accept="image/*" onChange={handleFileChange} ref={fileInputRef} className="hidden" />
                                    {image ? (<img src={image} alt="Yüklenen Soru" className="max-w-full max-h-48 sm:max-h-60 mx-auto rounded-lg shadow-md" />) : (<div className="text-center py-8 cursor-pointer w-full" onClick={triggerFileSelect}><svg className="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg><p className="mt-2 text-sm font-medium text-gray-700">1. Adım: Fotoğraf Yükle</p></div>)}
                                </div>
                                <div className="w-full md:w-1/2 flex flex-col justify-center space-y-3">
                                     {image && <button onClick={resetApp} className="w-full bg-red-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-600 transition duration-300">Yeni Soru Yükle</button>}
                                    <button onClick={handleAnalysis} disabled={isLoading || !selectedSubject} className="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">3. Adım: Analiz</button>
                                    <button onClick={handleSolution} disabled={isLoading || stage !== 'analysis_done'} className="w-full bg-purple-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-600 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">4. Adım: Çözüm</button>
                                    {isLoading && <div className="mt-4 flex items-center justify-center"><div className="loader"></div></div>}
                                </div>
                            </div>
                            {image && (<div className="w-full pt-4 border-t"><h2 className="text-lg font-semibold text-center text-gray-700 mb-3">2. Adım: Dersi Seç</h2><div className="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3">{subjects.map(subject => (<button key={subject} onClick={() => setSelectedSubject(subject)} className={`py-2 px-3 rounded-lg font-semibold transition-all duration-200 text-sm sm:text-base ${selectedSubject === subject ? 'rainbow-active' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>{subject}</button>))}</div></div>)}
                            {(analysis || solution) && (<div className="space-y-8 mt-6 pt-6 border-t">{analysis && (<div className="bg-blue-50 p-4 sm:p-5 rounded-lg shadow-sm border border-blue-200"><h2 className="text-lg sm:text-xl font-bold text-blue-800 mb-3">Analiz</h2><UniversalMathRenderer text={analysis} /></div>)}{solution && (<div><h2 className="text-xl sm:text-2xl font-bold text-indigo-800 mb-4 text-center">Çözüm</h2><UniversalMathRenderer text={solution} isSolution={true} /></div>)}</div>)}
                        </div>
                    </div>
                </div>
            );
        };
        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
